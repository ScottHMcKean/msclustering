---
title: "Microseismic Clustering"
author: "Scott McKean"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(msclustering)
```

This notebook runs the original data

```{r}
# load data
ms_df <- read_csv('../data/3_reprocessed_msdata.csv') %>%
  filter(mw >= -1.5)

survey_df <- read_csv('../data/3_reprocessed_surveys.csv') %>% 
  mutate(well = well_num)
  
comp_df <- read_csv('../data/3_reprocessed_completions.csv') %>%
  mutate(well = well_num) %>%
  mutate(stage = stage_num) %>%
  mutate(r_ap = l_raw * 1.88)
```

No separation at all

```{r}
ms_mock <- ms_df %>%
  mutate(class_well = 0, class_stage = 0, bool = 0)

noseparation <- run_gmm(ms_outlier = ms_mock, 
                        comp_df = comp_df, 
                        surv_df = survey_df, 
                        comp_start_col = "t",
                        ms_feat = c("x", "y", "z", "t"), 
                        ms_time_col = "t",
                        title_bool = FALSE, 
                        legend_bool = FALSE, 
                        plot = FALSE,
                        output_path = '../output/')

saveRDS(noseparation, file = '../output/1_no_separation.rds')
```

Original operator separation

```{r}
ms_op_class <- ms_df %>%
  mutate(class_well = well, class_stage = stage, bool = 0)
  
operator_class <- run_gmm(ms_outlier = ms_op_class, 
                          comp_df = comp_df, 
                          surv_df = survey_df, 
                          comp_start_col = "t",
                          ms_feat = c("x", "y", "z", "t"), 
                          ms_time_col = "t",
                          title_bool = FALSE, 
                          legend_bool = FALSE, 
                          plot = FALSE,
                          output_path = '../output/')
  
saveRDS(operator_class, file = '../output/2_operator_class.rds')
```

Reclassification

```{r}
ms_reclass <- classify_ms(ms_df = ms_df, 
                        comp_df = comp_df,
                        comp_tcol = 't', ms_tcol = 't')

ms_reclass$bool <- 0

reclassification <- run_gmm(ms_outlier = ms_reclass, 
                          comp_df = comp_df, 
                          surv_df = survey_df, 
                          comp_start_col = "t",
                          ms_feat = c("x", "y", "z", "t"), 
                          ms_time_col = "t",
                          title_bool = FALSE, 
                          legend_bool = FALSE, 
                          plot = FALSE,
                          output_path = '../output/')

saveRDS(reclassification, file = '../output/3_reclassification.rds')
```

Outlier Detection

```{r}
ms_out <- detect_outlier(ms_df = ms_reclass, comp_df, plot = FALSE) %>% as.data.frame()

outlier_detect <- run_gmm(ms_outlier = ms_out, 
                          comp_df = comp_df, 
                          surv_df = survey_df, 
                          comp_start_col = "t",
                          ms_feat = c("x", "y", "z", "t"), 
                          ms_time_col = "t",
                          title_bool = FALSE, 
                          legend_bool = FALSE, 
                          plot = FALSE,
                          output_path = '../output/')

saveRDS(outlier_detect, file = '../output/4_outlier_detect.rds')

gmm_ms_results <- outlier_detect[[1]]
gmm_clusters <- outlier_detect[[2]]

```

Cluster Quality Ranking

```{r}
clusters <- 'G:/My Drive/PhD/Analysis/marsh_creek/2020_01_09_msclustering_results/outlier_detect/xyzt_clusters.csv' %>%
  read_csv()

covariance <- 'G:/My Drive/PhD/Analysis/marsh_creek/2020_01_09_msclustering_results/outlier_detect/xyzt_covariancedata.csv' %>%
  read_csv()

ms_gmm_results <- 'G:/My Drive/PhD/Analysis/marsh_creek/2020_01_09_msclustering_results/outlier_detect/ms_gmm_results.csv' %>%
  read_csv()

# planarity
clusters %>%
  dplyr::mutate()

```
